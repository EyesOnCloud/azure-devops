trigger:
- master

variables:
  tag: '$(Build.BuildId)'
  
pool: 
  name: default 
  demands: 
    - agent.name -equals eoc-controller
  
stages:
  - stage: Build
    displayName: Build Stage
    jobs:
     - job: Build
       displayName: Build job
       steps:
         - task: Docker@2
           inputs:
             containerRegistry: 'docker-hub'
             repository: 'eyesoncloud/azdevops'
             command: 'buildAndPush'
             Dockerfile: '**/Dockerfile'
             tags: 
               $(tag)

         - script: |
           docker image remove eyesoncloud/azdevops:$(Build.BuildId)
           
         - task: Bash@3
           displayName: Deploy to Kubernetes
           inputs:
             targetType: 'inline'
             script: |
               sudo kubectl delete -f deployment.yml --ignore-not-found
               TAG=${BUILD_BUILDID}
               sed "s|tag|$TAG|g" deployment.yml > deployment-processed.yml
               sudo kubectl apply -f deployment-processed.yml


